name: bbx Saga Test Suite (Public Release)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag to test (defaults to release event tag)"
        required: false
        default: ""
      release_repo:
        description: "Repository that hosts the binaries"
        required: false
        default: "BrowserBox/BrowserBox"

concurrency:
  group: ${{ github.repository }}-bbx-saga-${{ github.event_name == 'release' && github.event.release.tag_name || github.event.inputs.release_tag || 'manual' }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  RELEASE_TAG: ${{ github.event_name == 'release' && github.event.release.tag_name || github.event.inputs.release_tag || '' }}
  TARGET_RELEASE_REPO: ${{ github.event.inputs.release_repo || 'BrowserBox/BrowserBox' }}

jobs:
  saga:
    name: Test on ${{ matrix.os }}
    continue-on-error: ${{ matrix.os == 'windows-latest' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15

    steps:
      - name: Resolve release tag
        shell: bash
        run: |
          tag="${RELEASE_TAG}"
          repo="${TARGET_RELEASE_REPO}"
          if [[ -z "$tag" ]]; then
            echo "RELEASE_TAG is required (from release event or workflow input)" >&2
            exit 1
          fi
          {
            echo "BBX_RELEASE_TAG=$tag"
            echo "BBX_RELEASE_REPO=$repo"
          } >> "$GITHUB_ENV"
          echo "Testing binaries from ${repo}@${tag}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare test script (Unix/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: chmod +x tests/test-bbx.sh

      - name: Execute BBX Test Saga (Unix/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        env:
          BBX_INSTALL_USER: "bbxuser"
          BBX_HOSTNAME: "localhost"
          BBX_NO_UPDATE: "true"
          BB_QUICK_EXIT: "yesplease"
          EMAIL: "test@example.com"
          LICENSE_KEY: ${{ secrets.BB_LICENSE_KEY }}
          BBX_TEST_AGREEMENT: "true"
          STATUS_MODE: ${{ secrets.STATUS_MODE_KEY }}
          INSTALL_DOC_VIEWER: "false"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BBX_RELEASE_REPO: ${{ env.BBX_RELEASE_REPO }}
          BBX_RELEASE_TAG: ${{ env.BBX_RELEASE_TAG }}
        run: |
          export BBX_NO_UPDATE=true
          export INSTALL_DOC_VIEWER STATUS_MODE BBX_TEST_AGREEMENT LICENSE_KEY EMAIL BBX_HOSTNAME BB_QUICK_EXIT BBX_RELEASE_REPO BBX_RELEASE_TAG
          ./tests/test-bbx.sh

      - name: Execute BBX Test Saga (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        env:
          BBX_NO_UPDATE: "true"
          BBX_FORCE_CHROME_INSTALL: "true"
          BBX_HOSTNAME: "localhost"
          EMAIL: "test@example.com"
          BB_QUICK_EXIT: "surewhatevs"
          LICENSE_KEY: ${{ secrets.BB_LICENSE_KEY }}
          BBX_TEST_AGREEMENT: "true"
          STATUS_MODE: ${{ secrets.STATUS_MODE_KEY }}
          BBX_RELEASE_REPO: ${{ env.BBX_RELEASE_REPO }}
          BBX_RELEASE_TAG: ${{ env.BBX_RELEASE_TAG }}
        run: |
          if (-not $env:BBX_RELEASE_TAG) {
            Write-Error "BBX_RELEASE_TAG is required"
            exit 1
          }
          .\windows-scripts\bbx.ps1 install
          if (-not (Get-Command bbx -ErrorAction SilentlyContinue)) {
            Write-Error "bbx not found in PATH after install"
            exit 1
          }
          winget install cURL.cURL --silent --accept-source-agreements --accept-package-agreements
          if (-not (Get-Command curl.exe -ErrorAction SilentlyContinue)) {
            Write-Error "curl.exe not installed"
            exit 1
          }
          bbx setup -Hostname "$env:BBX_HOSTNAME" -Email "$env:EMAIL" -Port 9999
          $loginLink = Get-Content "$env:USERPROFILE\.config\dosyago\bbpro\login.link"
          bbx run
          $response = curl.exe -k -L "$loginLink" -o NUL -w "%{http_code}"
          if ($response -eq "000") { Write-Error "Failed to connect"; exit 1 }
          Start-Sleep -Seconds 25
          $response = curl.exe -k -L "$loginLink" -o NUL -w "%{http_code}"
          if ($response -eq "000") { Write-Error "Second verification failed"; exit 1 }
          bbx stop

      - name: Print BBX Logs on Failure (Windows)
        if: failure() && matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $logDir = "$env:USERPROFILE\.config\dosyago\bbpro\logs"
          $logs = @("browserbox-main-out.log", "browserbox-main-err.log", "browserbox-devtools-out.log", "browserbox-devtools-err.log")
          foreach ($log in $logs) {
            $logPath = Join-Path $logDir $log
            if (Test-Path $logPath) {
              Write-Host "Contents of ${log}:"
              Get-Content $logPath
            } else {
              Write-Host "$log not found."
            }
          }

      - name: Cleanup (Unix/macOS)
        if: always() && matrix.os != 'windows-latest'
        shell: bash
        run: |
          ./bbx.sh stop || true
          pkill -f browserbox || true
