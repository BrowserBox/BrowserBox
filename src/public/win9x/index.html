<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>BrowserBox - Legacy Client</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=5">
<meta http-equiv="imagetoolbar" content="no" />
<style type="text/css">
  html, body { height: 100%; overflow: hidden; }
  body { font-family: "MS Sans Serif", "Tahoma", "Verdana", sans-serif; font-size: 12px; margin: 0; padding: 0; background-color: ButtonFace; color: ButtonText; overflow: hidden; }
  #main-layout { width: 100%; height: 100%; border-spacing: 0; }
  #tab-bar { background-color: ButtonFace; padding: 3px 2px 0 2px; border-bottom: 2px solid ThreeDShadow; white-space: nowrap; overflow: hidden; }
  .tab { display: inline-block; padding: 4px 8px; border: 1px solid ButtonFace; border-bottom: none; margin-right: 2px; cursor: pointer; background-color: ThreeDLightShadow; position: relative; top: 1px; }
  .tab-active { background-color: ButtonFace; border: 1px solid ThreeDShadow; border-bottom: 1px solid ButtonFace; font-weight: bold; }
  #omni-box { background-color: ButtonFace; padding: 5px; border-bottom: 2px outset ThreeDFace; }
  .omni-button { font-size: 12px; width: 60px; margin-right: 5px; }
  #url-input { font-size: 12px; width: 60%; }
  #status-bar { padding: 3px; border-top: 1px solid ThreeDShadow; font-size: 10px; color: ThreeDDarkShadow; }
  #content-pane {
    position: relative;
    background-color: #000000;
    overflow: hidden;
    padding: 0;
    border-top: 1px solid ThreeDLightShadow;
  }
  #remote-screen {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: #FFFFFF;
    cursor: crosshair;
  }
  #new-tab-button { display: inline-block; padding: 4px 6px; margin-right: 4px; border: 1px solid ThreeDShadow; background-color: ThreeDLightShadow; cursor: pointer; font-weight: bold; position: relative; top: 1px; }
  .close-tab-button { font-family: "Webdings", sans-serif; font-size: 12px; padding-left: 10px; color: ThreeDDarkShadow; cursor: pointer; }
</style>
</head>
<body>

<table id="main-layout" cellpadding="0" cellspacing="0">
  <tr style="height: 1px; display: none;">
    <td>
      <div style="padding: 5px;">
        Session Token:
        <input type="text" id="token-input" size="20" value="8723e327ccfe57f8803e0f1dd1d780e6">
        <button id="connect-button">Connect</button>
      </div>
    </td>
  </tr>
  <tr style="height: 25px;"><td><div id="tab-bar"></div></td></tr>
  <tr style="height: 35px;">
    <td>
      <div id="omni-box">
        <button id="back-button" class="omni-button" disabled>Back</button>
        <button id="forward-button" class="omni-button" disabled>Forward</button>
        <input type="text" id="url-input" disabled onfocus="isUrlBarFocused = true;" onblur="isUrlBarFocused = false;">
        <button id="go-button" class="omni-button" disabled>Go</button>
      </div>
    </td>
  </tr>
  <tr style="height: 100%;"><td id="content-pane"><img id="remote-screen" src="placeholder.gif" alt="Loading Remote Browser View ..." style="width: 100%; height: 100%;"></td></tr>
  <tr style="height: 20px;"><td><div id="status-bar">Status: Disconnected.</div></td></tr>
</table>

<script type="text/javascript">
  // --- IE4-5 polyfills ---
  if (!window.encodeURIComponent) {
    // Good enough for tokens/URLs in our app; handles ASCII + encodes '+'
    window.encodeURIComponent = function (s) {
      return escape(s).replace(/\+/g, '%2B');
    };
  }
  if (!window.decodeURIComponent) {
    window.decodeURIComponent = function (s) { return unescape(s); };
  }
</script>

<script type="text/javascript">
  // --- Configuration ---
  var KEY_BATCH_INTERVAL_MS = 1000;      // Send key events every 1s
  var MAX_KEYS_PER_BATCH    = 24;        // Keep URLs short for IE
  var keyBuffer = [];
  var keyBatchInterval = null;

  var VIEWPORT_SYNC_DELAY_MS = 750;      // Delay viewport sync on reconnect
  var isNetworkError = false;

  var API_BASE_PATH = '/api/vwin';
  if (location && location.origin) {
    API_BASE_PATH = location.origin + API_BASE_PATH;
  }
  var POLLING_INTERVAL_MS   = 1000;      // Frame-status idle poll rate
  var TAB_REFRESH_RATE_MS   = 3000;
  var RESIZE_DEBOUNCE_MS    = 300;       // 300ms debounce

  // Nudge capture: gently poke /frame when status says not fresh
  var NUDGE_MIN_MS = 400;
  var _lastNudgeAt = 0;
  var _nudgeImgBusy = false;
  var _nudgeImg = null;

  var tabPollingInterval = null;

  // --- State Variables ---
  var activeTabId = null;
  var isConnected = false;
  var modifierState = { shift: false, ctrl: false, alt: false };
  var resizeTimeout = null;
  var lastKnownFrameTimestamp = 0;
  var isUrlBarFocused = false;
  var _gettingFrame = false;

  // --- Element References ---
  var contentPane   = document.getElementById('content-pane');
  var connectButton = document.getElementById('connect-button');
  var tokenInput    = document.getElementById('token-input');
  var tabBar        = document.getElementById('tab-bar');
  var backButton    = document.getElementById('back-button');
  var forwardButton = document.getElementById('forward-button');
  var urlInput      = document.getElementById('url-input');
  var goButton      = document.getElementById('go-button');
  var remoteScreen  = document.getElementById('remote-screen');
  var statusBar     = document.getElementById('status-bar');

  var sessionToken = '';
  if (location.search) {
    sessionToken = location.search.replace('?token=', '');
    tokenInput.value = sessionToken;
  }

  // Helpers
  var HAS_XHR = (typeof XMLHttpRequest != "undefined") ||
                (window.ActiveXObject && document.getElementById);

  function createXmlHttpRequestObject() {
    // No try/catch anywhere
    if (typeof XMLHttpRequest != "undefined") {
      return new XMLHttpRequest();
    }
    // Only attempt ActiveX in IE5+ (IE4 lacks getElementById)
    if (window.ActiveXObject && document.getElementById) {
      return new ActiveXObject("Microsoft.XMLHTTP");
    }
    return null;
  }

  function parseJSON(jsonString) {
    // Minimal guard; avoid throwing on empty/garbage
    if (!jsonString || !jsonString.replace) return null;
    var s = jsonString.replace(/^\s+|\s+$/g, '');
    if (s.length === 0) return null;
    var first = s.charAt(0);
    if (first !== '{' && first !== '[') return null;
    // No try/catch; assume well-formed from server
    return eval('(' + s + ')');
  }

  function safeClearChildNodes(element) {
    while (element.firstChild) { element.removeChild(element.firstChild); }
  }

  function updateStatus(text) { statusBar.innerHTML = 'Status: ' + text; }

  function setControlsEnabled(isEnabled) {
    backButton.disabled = !isEnabled;
    forwardButton.disabled = !isEnabled;
    urlInput.disabled = !isEnabled;
    goButton.disabled = !isEnabled;
  }

  function handleReconnection() {
    if (isNetworkError) {
      isNetworkError = false;
      updateStatus('Connection re-established. Syncing viewport...');
      setTimeout(sendViewportSize, VIEWPORT_SYNC_DELAY_MS);
    }
  }

  function maybeNudgeCapture() {
    var now = (new Date()).getTime();
    if (_nudgeImgBusy) return;
    if (now - _lastNudgeAt < NUDGE_MIN_MS) return;

    _lastNudgeAt = now;
    _nudgeImgBusy = true;

    if (!_nudgeImg) { _nudgeImg = new Image(); }
    _nudgeImg.onload  = function() { _nudgeImgBusy = false; };
    _nudgeImg.onerror = function() { _nudgeImgBusy = false; };
    _nudgeImg.src = API_BASE_PATH + '/frame?session_token=' +
                    encodeURIComponent(sessionToken) +
                    '&nudge=1&ran=' + Math.random();
  }

  // --- Connection & Tabs ---
  function toggleConnection() {
    if (isConnected) {
      // Disconnect
      isConnected = false;
      stopKeyBatching();
      if (tabPollingInterval) { clearInterval(tabPollingInterval); tabPollingInterval = null; }
      sessionToken = '';
      activeTabId = null;
      lastKnownFrameTimestamp = 0;

      connectButton.innerHTML = 'Connect';
      updateStatus('Disconnected.');
      setControlsEnabled(false);
      safeClearChildNodes(tabBar);
      urlInput.value = '';
    } else {
      // Connect
      sessionToken = tokenInput.value;
      if (!sessionToken) {
        alert('Please enter a session token.');
        return;
      }

      updateStatus('Connecting...');
      connect();
      isConnected = true;

      sendViewportSize();
      updateTabs();
      pollForNextFrame();
      startKeyBatching();

      if (tabPollingInterval) clearInterval(tabPollingInterval);
      tabPollingInterval = setInterval(updateTabs, TAB_REFRESH_RATE_MS);
      connectButton.innerHTML = 'Disconnect';
      setControlsEnabled(true);
    }
  }

  function connect() {
    var xhr = createXmlHttpRequestObject();
    if (!xhr) { return false; }
    var url = API_BASE_PATH + '/connect?session_token=' +
              encodeURIComponent(sessionToken) +
              '&ran=' + Math.random();
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
        var data = parseJSON(xhr.responseText);
        if (data) { /* ok */ }
      } else if (xhr.readyState === 4) {
        if (!isNetworkError) {
          isNetworkError = true;
          updateStatus('Connection error. Attempting to reconnect...');
        }
      }
    };
    xhr.send(null);
  }

  function updateTabs() {
    if (!isConnected) return;
    var xhr = createXmlHttpRequestObject();
    if (!xhr) return;
    var url = API_BASE_PATH + '/tabs?session_token=' + encodeURIComponent(sessionToken) + '&ran=' + Math.random();

    xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
        handleReconnection();
        var data = parseJSON(xhr.responseText);
        if (data) {
          var tabs = data.tabs || [];
          renderTabs(tabs, data.activeTarget);
          activeTabId = data.activeTarget;
          if (!isUrlBarFocused && tabs.length) {
            var i;
            for (i = 0; i < tabs.length; i++) {
              if (tabs[i].targetId === activeTabId) {
                urlInput.value = tabs[i].url || '';
                break;
              }
            }
          }
        }
      } else if (xhr.readyState === 4) {
        if (!isNetworkError) {
          isNetworkError = true;
          updateStatus('Connection error. Attempting to reconnect...');
        }
      }
    };
    xhr.send(null);
  }

  function renderTabs(tabs, currentActiveId) {
    var previousActiveTab = activeTabId;
    safeClearChildNodes(tabBar);

    var newTabBtn = document.createElement('span');
    newTabBtn.id = 'new-tab-button';
    newTabBtn.innerHTML = '+';
    newTabBtn.onclick = handleNewTab;
    tabBar.appendChild(newTabBtn);

    var i;
    for (i = 0; i < tabs.length; i++) {
      var tab = tabs[i];
      var tabEl = document.createElement('span');
      tabEl.className = 'tab' + (tab.targetId === currentActiveId ? ' tab-active' : '');
      var titleText = (tab.title || 'New Tab').substring(0, 20);
      if (typeof tabEl.innerText !== 'undefined') tabEl.innerText = titleText; else tabEl.textContent = titleText;

      tabEl._tid = tab.targetId;
      tabEl.onclick = function() {
        var targetId = this._tid;
        if (targetId !== activeTabId) {
          activeTabId = targetId;
          sendEvent('type=switch');
        }
      };

      var closeBtn = document.createElement('span');
      closeBtn.className = 'close-tab-button';
      closeBtn.innerHTML = 'r'; // Webdings 'x'
      closeBtn._tid = tab.targetId;
      closeBtn.onclick = function(e) {
        e = e || window.event;
        if (e.stopPropagation) { e.stopPropagation(); } else { e.cancelBubble = true; }
        handleCloseTab(this._tid);
      };

      tabEl.appendChild(closeBtn);
      tabBar.appendChild(tabEl);
    }

    if (currentActiveId && currentActiveId !== previousActiveTab) {
      lastKnownFrameTimestamp = 0;
    }
  }

  // --- Frame polling ---
  function pollForNextFrame() {
    if (!isConnected || !activeTabId) {
      setTimeout(pollForNextFrame, POLLING_INTERVAL_MS);
      return;
    }

    var xhr = createXmlHttpRequestObject();
    if (!xhr) {
      // IE4 fallback: just refresh the image periodically
      updateScreenImage();
      setTimeout(pollForNextFrame, POLLING_INTERVAL_MS);
      return;
    }

    var url = API_BASE_PATH + '/frame-status?session_token=' +
              encodeURIComponent(sessionToken) +
              '&last_known_ts=' + lastKnownFrameTimestamp +
              '&ran=' + Math.random();

    xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
        handleReconnection();
        var data = parseJSON(xhr.responseText);
        if (data && data.fresh) {
          lastKnownFrameTimestamp = data.timestamp;
          updateScreenImage();
        } else {
          maybeNudgeCapture();
          setTimeout(pollForNextFrame, POLLING_INTERVAL_MS);
        }
      } else if (xhr.readyState === 4) {
        if (!isNetworkError) {
          isNetworkError = true;
          updateStatus('Connection error. Attempting to reconnect...');
        }
        setTimeout(pollForNextFrame, POLLING_INTERVAL_MS * 2);
      }
    };
    xhr.send(null);
  }

  function updateScreenImage() {
    if (_gettingFrame) return;
    _gettingFrame = true;

    var parent = contentPane; if (!parent) { _gettingFrame = false; return; }

    var newImage = document.createElement('img');

    newImage.onload = function() {
      var oldImage = document.getElementById('remote-screen');
      newImage.id = 'remote-screen';
      newImage.alt = oldImage.alt;
      newImage.style.cssText = oldImage.style.cssText;
      newImage.onclick = handleScreenClick;
      parent.appendChild(newImage);
      if (oldImage) {
        oldImage.onload = null;
        oldImage.onerror = null;
        parent.removeChild(oldImage);
      }
      remoteScreen = newImage;
      remoteScreen.alt = "BrowserBox View";
      updateStatus('Frame ' + (lastKnownFrameTimestamp || '?') + ' loaded.');
      _gettingFrame = false;
      pollForNextFrame();
    };

    newImage.onerror = function() {
      if (!isNetworkError) {
        isNetworkError = true;
        updateStatus('Connection error. Retrying...');
      }
      _gettingFrame = false;
      setTimeout(pollForNextFrame, POLLING_INTERVAL_MS);
    };

    var newSrc = API_BASE_PATH + '/frame?session_token=' + encodeURIComponent(sessionToken);
    if (lastKnownFrameTimestamp) { newSrc += '&ts=' + lastKnownFrameTimestamp; }
    newSrc += '&ran=' + Math.random();

    newImage.src = newSrc;
  }

  // --- Events to backend ---
  var _evtPool = [];        // keep references so IE doesn't abort GETs
  var _evtPoolPos = 0;
  var _evtPoolCap = 8;

  function sendEvent(params) {
    if (!isConnected) return;
    var eventUrl = API_BASE_PATH + '/event?session_token=' + encodeURIComponent(sessionToken) +
                   (activeTabId ? '&targetId=' + encodeURIComponent(activeTabId) : '') +
                   '&' + params + '&cb=' + ((new Date()).getTime() % 1e9);
    var img = new Image();
    _evtPool[_evtPoolPos] = img;                 // circular buffer, no shift()
    _evtPoolPos = (_evtPoolPos + 1) % _evtPoolCap;
    img.src = eventUrl;
  }

  function sendViewportSize() {
    var w = contentPane.clientWidth  || contentPane.offsetWidth  || remoteScreen.offsetWidth  || 0;
    var h = contentPane.clientHeight || contentPane.offsetHeight || remoteScreen.offsetHeight || 0;
    remoteScreen.width  = w;
    remoteScreen.height = h;
    sendEvent('type=resize&width=' + w + '&height=' + h);
    updateStatus('Sent viewport dimensions: ' + w + 'x' + h);
  }

  // 300ms debounce
  function throttledResizeHandler() {
    if (resizeTimeout) { clearTimeout(resizeTimeout); }
    resizeTimeout = setTimeout(function() {
      if (isConnected) { sendViewportSize(); }
    }, RESIZE_DEBOUNCE_MS);
  }

  // --- Mouse & keyboard ---
  function getElementOffset(el) {
    var x = 0, y = 0;
    while (el) { x += el.offsetLeft || 0; y += el.offsetTop || 0; el = el.offsetParent; }
    return {x:x, y:y};
  }

  function handleScreenClick(e) {
    e = e || window.event;
    var off = getElementOffset(remoteScreen);
    var cx = (e.clientX != null ? e.clientX : 0) + (document.documentElement && document.documentElement.scrollLeft || document.body.scrollLeft || 0);
    var cy = (e.clientY != null ? e.clientY : 0) + (document.documentElement && document.documentElement.scrollTop  || document.body.scrollTop  || 0);
    var x = (e.offsetX != null) ? e.offsetX : (cx - off.x);
    var y = (e.offsetY != null) ? e.offsetY : (cy - off.y);
    sendEvent('type=mousedown&x=' + x + '&y=' + y);
  }

  function handleMouseWheel(e) {
    e = e || window.event;
    var targetElement = e.target || e.srcElement;
    if (targetElement.id !== 'remote-screen') { return; }
    if (!isConnected) return;

    var x = e.offsetX || (e.pageX - remoteScreen.offsetLeft);
    var y = e.offsetY || (e.pageY - remoteScreen.offsetTop);
    var delta = e.wheelDelta || -e.detail;
    sendEvent('type=mousewheel&x=' + x + '&y=' + y + '&deltaY=' + delta);
  }

  var nonPrintableKeys = [8,9,13,27,33,34,35,36,37,38,39,40,45,46];

  function indexOf(arr, val) {
    var i;
    for (i = 0; i < arr.length; i++) { if (arr[i] == val) return i; }
    return -1;
  }

  // Key batching (URL-size-safe)
  function startKeyBatching() {
    if (keyBatchInterval) { clearInterval(keyBatchInterval); }
    keyBatchInterval = setInterval(sendKeyBatch, KEY_BATCH_INTERVAL_MS);
  }
  function stopKeyBatching() {
    if (keyBatchInterval) { clearInterval(keyBatchInterval); keyBatchInterval = null; }
    keyBuffer = [];
  }
  function sendKeyBatch() {
    if (keyBuffer.length === 0) return;

    var start = 0;
    while (start < keyBuffer.length) {
      var end = start + MAX_KEYS_PER_BATCH;
      var chunk = [];
      var i;
      for (i = start; i < end && i < keyBuffer.length; i++) {
        chunk[chunk.length] = keyBuffer[i];
      }

      // Manual JSON for IE
      var eventsJson = '[';
      for (i = 0; i < chunk.length; i++) {
        var keyEvent = chunk[i];
        eventsJson += '{' +
          '"p":"' + (keyEvent.press || '') + '",' +
          '"k":' + (keyEvent.keyCode != null ? keyEvent.keyCode : '""') + ',' +
          '"s":' + (keyEvent.shiftKey ? 1 : 0) + ',' +
          '"c":' + (keyEvent.ctrlKey ? 1 : 0) + ',' +
          '"a":' + (keyEvent.altKey ? 1 : 0) +
        '}';
        if (i < chunk.length - 1) eventsJson += ',';
      }
      eventsJson += ']';

      sendEvent('type=key_batch&events=' + encodeURIComponent(eventsJson));
      start = end;
    }

    keyBuffer = [];
  }

  // Key handling
  function handleKeyDown(e) {
    if (!isConnected) return;
    e = e || window.event;
    var keyCode = e.keyCode || e.which;

    if (isUrlBarFocused) {
      if (keyCode === 13) {
        handleNavigate();
        e.returnValue = false; if (e.preventDefault) e.preventDefault();
      }
      return;
    }

    if (indexOf(nonPrintableKeys, keyCode) !== -1) {
      keyBuffer[keyBuffer.length] = {
        keyCode: keyCode,
        shiftKey: e.shiftKey,
        ctrlKey: e.ctrlKey,
        altKey: e.altKey
      };
      e.returnValue = false; if (e.preventDefault) e.preventDefault();
    }
  }

  function handleKeyPress(e) {
    if (!isConnected || isUrlBarFocused) return;
    e = e || window.event;
    var charCode = e.charCode || e.keyCode;
    keyBuffer[keyBuffer.length] = {
      press: String.fromCharCode(charCode),
      shiftKey: e.shiftKey,
      ctrlKey: e.ctrlKey,
      altKey: e.altKey
    };
  }

  // --- Navigation helpers (no throw/try) ---
  function parseURL(u) {
    var url = u;
    if (/^[a-z0-9.-]+\.[a-z]{2,}/i.test(url)) { url = "https://" + url; }
    var a = document.createElement('a'); a.href = url;
    if (!/^https?:$/.test(a.protocol) || !a.hostname) { return null; }
    return {
      href: a.href,
      protocol: a.protocol,
      host: a.host,
      hostname: a.hostname,
      port: a.port,
      pathname: a.pathname,
      search: a.search,
      hash: a.hash
    };
  }

  function handleNavigate() {
    var raw = urlInput.value; if (!raw) return;
    var u = parseURL(raw);
    if (!u) { u = parseURL('https://' + raw); }
    if (!u) {
      sendEvent('type=navigate&url=' + encodeURIComponent('https://duckduckgo.com/?q=' + raw));
      return;
    }
    sendEvent('type=navigate&url=' + encodeURIComponent(u.href));
  }

  function handleBack()   { sendEvent('type=back'); }
  function handleForward(){ sendEvent('type=forward'); }
  function handleNewTab() { sendEvent('type=new_tab'); }
  function handleCloseTab(targetIdToClose) { sendEvent('type=close_tab&targetIdToClose=' + targetIdToClose); }

  // --- Attach Events ---
  connectButton.onclick = toggleConnection;
  remoteScreen.onclick  = handleScreenClick;
  goButton.onclick      = handleNavigate;
  backButton.onclick    = handleBack;
  forwardButton.onclick = handleForward;
  window.onresize       = throttledResizeHandler;
  document.onkeydown    = handleKeyDown;
  document.onkeypress   = handleKeyPress;

  if (document.addEventListener) {
    document.addEventListener('mousewheel', handleMouseWheel, false);
    document.addEventListener('DOMMouseScroll', handleMouseWheel, false);
  } else {
    document.onmousewheel = handleMouseWheel;
  }

  // Auto-connect if token present (no try/catch)
  if (connectButton && connectButton.click) { connectButton.click(); }
  else { toggleConnection(); }

  window.onerror = function(message, url, line) {
    alert("Error: " + message + " at line " + line);
    return true; // Prevents default error handling
  };
</script>

</body>
</html>

