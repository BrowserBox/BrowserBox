<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>BrowserBox - Legacy Client</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=5">
<meta http-equiv="imagetoolbar" content="no" />
<style type="text/css">
  html, body { height: 100%; overflow: hidden; }
  body { font-family: "MS Sans Serif", "Tahoma", "Verdana", sans-serif; font-size: 12px; margin: 0; padding: 0; background-color: ButtonFace; color: ButtonText; overflow: hidden; }
  #main-layout { width: 100%; height: 100%; border-spacing: 0; }
  #tab-bar { background-color: ButtonFace; padding: 3px 2px 0 2px; border-bottom: 2px solid darkgray; white-space: nowrap; overflow: hidden; }
  .tab { display: inline-block; padding: 4px 8px; border: 1px solid ButtonFace; border-bottom: none; margin-right: 2px; cursor: pointer; background-color: darkgray; position: relative; top: 1px; }
  .tab-active { background-color: ButtonFace; border: 1px solid darkgray; border-bottom: 1px solid ButtonFace; font-weight: bold; }
  #omni-box { background-color: ButtonFace; padding: 5px; border-bottom: 2px outset silver; }
  .omni-button { font-size: 12px; width: 60px; margin-right: 5px; }
  #url-input { font-size: 12px; width: 60%; }
  #status-bar { padding: 3px; border-top: 1px solid darkgray; font-size: 10px; color: black; }
  #content-pane {
    position: relative;
    background-color: #000000;
    overflow: hidden;
    padding: 0;
    border-top: 1px solid darkgray;
  }
  #remote-screen {
    position: absolute;
    display: block;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: #FFFFFF;
    cursor: crosshair;
  }
  #new-tab-button { display: inline-block; padding: 4px 6px; margin-right: 4px; border: 1px solid darkgray; background-color: silver; cursor: pointer; font-weight: bold; position: relative; top: 1px; }
  .close-tab-button { font-family: "Webdings", sans-serif; font-size: 12px; padding-left: 10px; color: darkgray; cursor: pointer; }
</style>
</head>
<body>

<script type="text/javascript" language="JavaScript">
  // Minimal Array.prototype.shift / unshift for IE4–6 (JScript)
  if (!Array.prototype.shift) {
    Array.prototype.shift = function () {
      var len = this.length >>> 0;          // coerce to uint32
      if (!len) { this.length = 0; return void 0; }
      var first = this[0];
      for (var i = 1; i < len; i++) this[i - 1] = this[i];
      this.length = len - 1;                // shrink without 'delete' (faster in old JScript)
      return first;
    };
  }

  // Optional: unshift (not strictly needed for your snippet, but handy)
  if (!Array.prototype.unshift) {
    Array.prototype.unshift = function () {
      var add = arguments.length, len = this.length >>> 0, i;
      if (!add) return len;
      for (i = len - 1; i >= 0; i--) this[i + add] = this[i];
      for (i = 0; i < add; i++) this[i] = arguments[i];
      this.length = len + add;
      return this.length;
    };
  }
</script>

<table id="main-layout" cellpadding="0" cellspacing="0">
  <tr style="height: 1px; display: none;">
    <td>
      <div style="padding: 5px;">
        Session Token:
        <input type="text" id="token-input" size="20" value="8723e327ccfe57f8803e0f1dd1d780e6">
        <button id="connect-button">Connect</button>
      </div>
    </td>
  </tr>
  <tr style="height: 25px;"><td><div id="tab-bar"></div></td></tr>
  <tr style="height: 35px;">
    <td>
      <div id="omni-box">
        <button id="back-button" class="omni-button" disabled>Back</button>
        <button id="forward-button" class="omni-button" disabled>Forward</button>
        <input type="text" id="url-input" disabled onfocus="isUrlBarFocused = true;" onblur="isUrlBarFocused = false;">
        <button id="go-button" class="omni-button" disabled>Go</button>
      </div>
    </td>
  </tr>
  <tr style="height: 100%;"><td id="content-pane"><img id="remote-screen" src="placeholder.gif" alt="Loading Remote Browser View ..." style="width: 100%; height: 100%;"></td></tr>
  <tr style="height: 20px;"><td><div id="status-bar">Status: Disconnected.</div></td></tr>
</table>

<!-- Polyfills (IE4-5 safe) -->
<script type="text/javascript" language="JavaScript">
  if (!window.encodeURIComponent) {
    window.encodeURIComponent = function (s) { return escape(s).split('+').join('%2B'); };
  }
  if (!window.decodeURIComponent) {
    window.decodeURIComponent = function (s) { return unescape(s); };
  }
</script>

<!-- DOM helper with IE4 fallback -->
<script type="text/javascript" language="JavaScript">
  function getEl(id) {
    if (document.getElementById) return document.getElementById(id);
    if (document.all) return document.all[id];
    return null;
  }
</script>

<script type="text/javascript" language="JavaScript">
  // Minimal JSON + stringify for IE4–6 (debug-safe)
  if (!window.JSON) { window.JSON = {}; }

  if (!JSON.stringify) {
    (function () {
      function escStr(s) {
        // Escape quotes, backslashes, and control chars < 0x20
        var out = '', i, c, ch;
        for (i = 0; i < s.length; i++) {
          c = s.charCodeAt(i);
          ch = s.charAt(i);
          if (ch === '"' || ch === '\\') { out += '\\' + ch; }
          else if (c < 0x20) {
            if (ch === '\b') out += '\\b';
            else if (ch === '\f') out += '\\f';
            else if (ch === '\n') out += '\\n';
            else if (ch === '\r') out += '\\r';
            else if (ch === '\t') out += '\\t';
            else {
              var h = c.toString(16);
              while (h.length < 4) h = '0' + h;
              out += '\\u' + h;
            }
          } else {
            out += ch;
          }
        }
        return '"' + out + '"';
      }

      function isArray(a) {
        return a && (a.constructor === Array || (typeof a.length === 'number' && typeof a.splice === 'function'));
      }

      function isDate(d) {
        return d && typeof d.getUTCFullYear === 'function';
      }

      function stringify(val, stack) {
        var t = typeof val;

        if (val === null) return 'null';
        if (t === 'string') return escStr(val);
        if (t === 'number') return isFinite(val) ? String(val) : 'null';
        if (t === 'boolean') return val ? 'true' : 'false';

        stack = stack || [];
        // Circular ref guard
        for (var si = 0; si < stack.length; si++) {
          if (stack[si] === val) return escStr('[Circular]');
        }

        if (isDate(val)) {
          // ISO not available; use UTC string for debugging
          return escStr(val.toUTCString ? val.toUTCString() : String(val));
        }

        if (isArray(val)) {
          stack[stack.length] = val;
          var arrOut = [];
          for (var i = 0; i < val.length; i++) {
            // JSON.stringify puts null for unsupported/undefined
            var v = stringify(val[i], stack);
            arrOut[arrOut.length] = (typeof val[i] === 'undefined' || typeof val[i] === 'function') ? 'null' : v;
          }
          stack.length = stack.length - 1;
          return '[' + arrOut.join(',') + ']';
        }

        if (t === 'object') {
          stack[stack.length] = val;
          var first = true, parts = [];
          // Prefer own props when possible
          var hasOwn = Object.prototype.hasOwnProperty;
          for (var k in val) {
            if (hasOwn ? hasOwn.call(val, k) : true) {
              var v2 = val[k];
              var vt = typeof v2;
              if (vt !== 'undefined' && vt !== 'function') {
                parts[parts.length] = escStr(k) + ':' + stringify(v2, stack);
              }
            }
          }
          stack.length = stack.length - 1;
          return '{' + parts.join(',') + '}';
        }

        // functions / undefined
        return 'null';
      }

      JSON.stringify = function (value) {
        return stringify(value, []);
      };
    })();
  }

  // Handy helpers for debugging in old IE
  if (!window.debugAlert) {
    window.debugAlert = function (label, value) {
      try {
        var s = JSON.stringify(value);
        // Old alert boxes choke on huge strings—trim if massive
        if (s.length > 1000) s = s.substr(0, 1000) + '…';
        alert((label ? label + ': ' : '') + s);
      } catch (e) {
        alert((label ? label + ': ' : '') + '[unserializable] ' + (e && e.message ? e.message : e));
      }
    };
  }
</script>

<script type="text/javascript" language="JavaScript">
  // --- Configuration ---
  var KEY_BATCH_INTERVAL_MS = 1000;
  var MAX_KEYS_PER_BATCH    = 24;
  var keyBuffer = [];
  var keyBatchInterval = null;

  var VIEWPORT_SYNC_DELAY_MS = 750;
  var isNetworkError = false;

  var API_BASE_PATH = '/api/vwin';
  if (location && location.origin) {
    API_BASE_PATH = location.origin + API_BASE_PATH;
  }
  var POLLING_INTERVAL_MS = 800;
  var TAB_REFRESH_RATE_MS = 4000;
  var RESIZE_THROTTLE_MS  = 1000; // 1s debounce

  var NUDGE_MIN_MS = 400;
  var _lastNudgeAt = 0;
  var _nudgeImgBusy = false;
  var _nudgeImg = null;

  var tabPollingInterval = null;

  // --- State Variables ---
  var activeTabId = null;
  var isConnected = false;
  var modifierState = { shift: false, ctrl: false, alt: false };
  var resizeTimeout = null;
  var lastKnownFrameTimestamp = 0;
  var isUrlBarFocused = false;
  var _gettingFrame = false;

  // --- Element References ---
  var contentPane   = getEl('content-pane');
  var connectButton = getEl('connect-button');
  var tokenInput    = getEl('token-input');
  var tabBar        = getEl('tab-bar');
  var backButton    = getEl('back-button');
  var forwardButton = getEl('forward-button');
  var urlInput      = getEl('url-input');
  var goButton      = getEl('go-button');
  var remoteScreen  = getEl('remote-screen');
  var statusBar     = getEl('status-bar');

  var sessionToken = '';

  // Use ONLY the 'token' param
  var sessionToken = getQueryParam('token') || '';
  if (sessionToken) { tokenInput.value = sessionToken; }

  // --- JSON / Net helpers (JSONP for IE4/5) ---
    var USE_JSONP = !window.XMLHttpRequest;

    var _jsonpSeq = 0;

    function jsonp(fullUrl, onOK) {
      // Ensure BODY exists (IE4 can run this before <body> is live)
      if (!document.body) { setTimeout(function(){ jsonp(fullUrl, onOK); }, 50); return; }

      var cb = '__bbcb' + (++_jsonpSeq);
      window[cb] = function (data) { window[cb] = null; if (onOK) onOK(data); };

      var url = fullUrl + (fullUrl.indexOf('?')>=0 ? '&' : '?') +
                'jsonp=1&callback=' + cb + '&ran=' + Math.random();

      // Best path first
      if (document.createElement) {
        var s = document.createElement('script');
        if ( s ) {
          s.type = 'text/javascript';
          s.src  = url;

          if (document.body.appendChild) {
            document.body.appendChild(s);
            return;
          }
          if (document.body.insertAdjacentElement) {
            document.body.insertAdjacentElement('beforeEnd', s);
            return;
          }
        }
        if (document.body.insertAdjacentHTML) {
          setTimeout(function () {
            document.body.insertAdjacentHTML(
              'beforeEnd',
              '<script type="text/javascript" src="' + url + '"></' + 'script>'
            );
            return;
          });
          return;
        }
      }

      if (document.body && document.body.insertAdjacentHTML) {
        document.body.insertAdjacentHTML(
          'beforeEnd',
          '<script type="text/javascript" src="' + url + '"></' + 'script>'
        );
      }
    }

    function getJSON(fullUrl, onOK, onErr) {
      if (USE_JSONP) { jsonp(fullUrl, onOK); return; }
      var xhr = new XMLHttpRequest();
      xhr.open('GET', fullUrl, true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) { onOK(parseJSON(xhr.responseText)); }
          else if (onErr) { onErr(); }
        }
      };
      xhr.send(null);
    }

    function netErr() {
      if (!isNetworkError) {
        isNetworkError = true;
        updateStatus('Connection error. Attempting to reconnect...');
      }
    }

    function parseJSON(jsonString) {
      return eval('(' + jsonString + ')');
    }

  // query funcs
    function _decodeQS(s) {
      // IE-safe decode: handle + as space, fall back to unescape
      try { return decodeURIComponent(String(s).replace(/\+/g, '%20')); }
      catch (e) { return unescape(String(s)); }
    }

    function getQueryParam(name) {
      var q = (location && location.search) ? String(location.search).replace(/^\?/, '') : '';
      if (!q) return '';
      var parts = q.split('&');
      for (var i = 0; i < parts.length; i++) {
        var kv = parts[i].split('=');
        if (_decodeQS(kv[0]) === name) {
          // Rejoin in case value contained '='
          var rest = kv.slice(1).join('=');
          return _decodeQS(rest);
        }
      }
      return '';
    }


  function safeClearChildNodes(el) {
    if (!el) return;
    if (typeof el.innerHTML != 'undefined') { el.innerHTML = ''; return; }
    while (el.firstChild) { el.removeChild(el.firstChild); }
  }

  function updateStatus(text) {
    // Uncomment if you want the status bar to spam less:
    statusBar.innerHTML = 'Status: ' + text;
  }

  function setControlsEnabled(isEnabled) {
    backButton.disabled = !isEnabled;
    forwardButton.disabled = !isEnabled;
    urlInput.disabled = !isEnabled;
    goButton.disabled = !isEnabled;
  }

  function handleReconnection() {
    if (isNetworkError) {
      isNetworkError = false;
      updateStatus('Connection re-established. Syncing viewport...');
      setTimeout(sendViewportSize, VIEWPORT_SYNC_DELAY_MS);
    }
  }

  function maybeNudgeCapture() {
    var now = (new Date()).getTime();
    if (_nudgeImgBusy) return;
    if (now - _lastNudgeAt < NUDGE_MIN_MS) return;

    _lastNudgeAt = now;
    _nudgeImgBusy = true;

    if (!_nudgeImg) { _nudgeImg = new Image(); }
    _nudgeImg.onload = function() { _nudgeImgBusy = false; };
    _nudgeImg.onerror = function() { _nudgeImgBusy = false; };
    _nudgeImg.src = API_BASE_PATH + '/frame?session_token=' +
                    encodeURIComponent(sessionToken) +
                    '&nudge=1&ran=' + Math.random();
  }

  // --- Connection & Tabs ---
  function toggleConnection() {
    if (isConnected) {
      isConnected = false;
      stopKeyBatching();
      if (tabPollingInterval) { clearInterval(tabPollingInterval); tabPollingInterval = null; }
      sessionToken = '';
      activeTabId = null;
      lastKnownFrameTimestamp = 0;

      connectButton.innerHTML = 'Connect';
      updateStatus('Disconnected.');
      setControlsEnabled(false);
      safeClearChildNodes(tabBar);
      urlInput.value = '';
    } else {
      sessionToken = tokenInput.value;
      if (!sessionToken) { alert('Please enter a session token.'); return; }

      updateStatus('Connecting...');
      connect();
      isConnected = true;

      sendViewportSize();
      updateTabs();
      pollForNextFrame();
      startKeyBatching();

      if (tabPollingInterval) clearInterval(tabPollingInterval);
      tabPollingInterval = setInterval(updateTabs, TAB_REFRESH_RATE_MS);
      connectButton.innerHTML = 'Disconnect';
      setControlsEnabled(true);
    }
  }

  function connect() {
    var url = API_BASE_PATH + '/connect?session_token=' +
              encodeURIComponent(sessionToken) + '&ran=' + Math.random();
    getJSON(url, function(data){ /* ok */ }, netErr);
  }

  function updateTabs() {
    if (!isConnected) return;
    var url = API_BASE_PATH + '/tabs?session_token=' +
              encodeURIComponent(sessionToken) + '&ran=' + Math.random();

    getJSON(url, function(data) {
      handleReconnection();
      if (!data) return;
      //alert(JSON.stringify(data));
      var tabs = data.tabs || [];
      renderTabs(tabs, data.activeTarget);
      activeTabId = data.activeTarget;
      if (!isUrlBarFocused && tabs.length) {
        for (var i=0; i<tabs.length; i++) {
          if (tabs[i].targetId === activeTabId) { urlInput.value = tabs[i].url || ''; break; }
        }
      }
    }, netErr);
  }

  // --- Frame polling (JSONP/XHR via getJSON) ---
  function pollForNextFrame() {
    if (!isConnected || !activeTabId) {
      setTimeout(pollForNextFrame, POLLING_INTERVAL_MS);
      return;
    }

    var url = API_BASE_PATH + '/frame-status?session_token=' +
              encodeURIComponent(sessionToken) +
              '&targetId=' + encodeURIComponent(activeTabId) +
              '&last_known_ts=' + lastKnownFrameTimestamp +
              '&ran=' + Math.random();

    getJSON(url, function(data) {
      handleReconnection();
      if (data && data.fresh) {
        lastKnownFrameTimestamp = data.timestamp;
        updateScreenImage();
      } else {
        maybeNudgeCapture();
        setTimeout(pollForNextFrame, POLLING_INTERVAL_MS);
      }
    }, function() {
      netErr();
      setTimeout(pollForNextFrame, POLLING_INTERVAL_MS * 2);
    });
  }

  function updateScreenImage() {
    if (_gettingFrame) return;
    _gettingFrame = true;

    var newSrc = API_BASE_PATH + '/frame?session_token=' +
                 encodeURIComponent(sessionToken) +
                 '&targetId=' + encodeURIComponent(activeTabId || '') +
                 (lastKnownFrameTimestamp ? '&ts=' + lastKnownFrameTimestamp : '') +
                 '&ran=' + Math.random();

    // IE4 fallback: just swap src and keep polling
    if (!document.getElementById && document.all) {
      remoteScreen.src = newSrc;
      _gettingFrame = false;
      setTimeout(pollForNextFrame, POLLING_INTERVAL_MS);
      return;
    }

    // IE5+/others: swap node to avoid caching artifacts
    var parent = contentPane; if (!parent) { _gettingFrame = false; return; }
    var newImage = document.createElement('img');
    newImage.onload = function () {
      var oldImage = getEl('remote-screen');
      newImage.id = 'remote-screen';
      newImage.alt = oldImage.alt;
      newImage.style.cssText = oldImage.style.cssText;
      newImage.onclick = handleScreenClick;
      parent.appendChild(newImage);
      if (oldImage) { oldImage.onload = oldImage.onerror = null; parent.removeChild(oldImage); }
      remoteScreen = newImage;
      remoteScreen.alt = "BrowserBox View";
      updateStatus('Frame ' + (lastKnownFrameTimestamp || '?') + ' loaded.');
      _gettingFrame = false;
      pollForNextFrame();
    };
    newImage.onerror = function () {
      if (!isNetworkError) { isNetworkError = true; updateStatus('Connection error. Retrying...'); }
      _gettingFrame = false;
      setTimeout(pollForNextFrame, POLLING_INTERVAL_MS);
    };
    newImage.src = newSrc;
  }

  // --- Events to backend ---
  var _evtPool = [];
  var _evtPoolMax = 8;

  function sendEvent(params) {
    if (!isConnected) return;

    var url = API_BASE_PATH + '/event?session_token=' + encodeURIComponent(sessionToken) +
              (activeTabId ? '&targetId=' + encodeURIComponent(activeTabId) : '') +
              '&' + params +
              '&cb=' + (new Date().getTime() % 1000000000) + '&ran=' + Math.random();

    if (window.Image) {
      var img = new Image();
      _evtPool[_evtPool.length] = img;
      if (_evtPool.length > _evtPoolMax) {
        _evtPool.shift();
      }
      img.src = url;
    } else {
      var f = document.getElementById ? document.getElementById('evt-iframe') :
              (document.all ? document.all['evt-iframe'] : null);
      if (!f && document.body) {
        if (document.body.insertAdjacentHTML) {
          document.body.insertAdjacentHTML('beforeEnd','<iframe id="evt-iframe" width="0" height="0" frameborder="0"></iframe>');
          f = document.all ? document.all['evt-iframe'] : document.getElementById('evt-iframe');
        }
      }
      if (f) { f.src = url; }
    }
  }

  // --- Viewport sizing (robust fallbacks) ---
  function sendViewportSize() {
    var w = contentPane.clientWidth  || contentPane.offsetWidth  || remoteScreen.offsetWidth  || 0;
    var h = contentPane.clientHeight || contentPane.offsetHeight || remoteScreen.offsetHeight || 0;
    remoteScreen.width  = w;
    remoteScreen.height = h;
    sendEvent('type=resize&width=' + w + '&height=' + h);
  }

  // 1s debounce
  function throttledResizeHandler() {
    remoteScreen.style.display = 'none';
    if (resizeTimeout) { clearTimeout(resizeTimeout); }
    resizeTimeout = setTimeout(doResize, RESIZE_THROTTLE_MS);
  }

  function doResize() {
    remoteScreen.style.display = 'block';
    if (isConnected) { 
      sendViewportSize(); 
    }
  }

  // --- Mouse helpers (for old IE) ---
  function getScroll() {
    var d = document.documentElement, b = document.body;
    return { x: (d && d.scrollLeft) || (b && b.scrollLeft) || 0,
             y: (d && d.scrollTop)  || (b && b.scrollTop)  || 0 };
  }
  function getOffset(el) {
    var x=0,y=0; while (el) { x += el.offsetLeft||0; y += el.offsetTop||0; el = el.offsetParent; }
    return {x:x,y:y};
  }

  // --- Mouse & keyboard ---
  function handleScreenClick(e) {
    e = e || window.event;
    var off = getOffset(remoteScreen), scr = getScroll();
    var cx = (e.clientX != null ? e.clientX : 0) + scr.x;
    var cy = (e.clientY != null ? e.clientY : 0) + scr.y;
    var x = (e.offsetX != null) ? e.offsetX : (cx - off.x);
    var y = (e.offsetY != null) ? e.offsetY : (cy - off.y);
    sendEvent('type=mousedown&x=' + x + '&y=' + y);
  }

  function handleMouseWheel(e) {
    e = e || window.event;
    var t = e.target || e.srcElement; if (!t || t.id !== 'remote-screen') return;
    var off = getOffset(remoteScreen), scr = getScroll();
    var cx = (e.clientX != null ? e.clientX : 0) + scr.x;
    var cy = (e.clientY != null ? e.clientY : 0) + scr.y;
    var x = (e.offsetX != null) ? e.offsetX : (cx - off.x);
    var y = (e.offsetY != null) ? e.offsetY : (cy - off.y);
    var delta = (typeof e.wheelDelta != 'undefined') ? e.wheelDelta : -(e.detail || 0);
    sendEvent('type=mousewheel&x=' + x + '&y=' + y + '&deltaY=' + delta);
  }

  var nonPrintableKeys = [8,9,13,27,33,34,35,36,37,38,39,40,45,46];

  function indexOf(arr, val) {
    for (var i = 0; i < arr.length; i++) { if (arr[i] == val) return i; }
    return -1;
  }

  // Key batching
  function startKeyBatching() {
    if (keyBatchInterval) { clearInterval(keyBatchInterval); }
    keyBatchInterval = setInterval(sendKeyBatch, KEY_BATCH_INTERVAL_MS);
  }
  function stopKeyBatching() {
    if (keyBatchInterval) { clearInterval(keyBatchInterval); keyBatchInterval = null; }
    keyBuffer = [];
  }
  function sendKeyBatch() {
    if (keyBuffer.length === 0) return;

    var start = 0;
    while (start < keyBuffer.length) {
      var end = start + MAX_KEYS_PER_BATCH;
      var chunk = [];
      for (var i = start; i < end && i < keyBuffer.length; i++) {
        chunk[chunk.length] = keyBuffer[i];
      }

      var eventsJson = '[';
      for (var j = 0; j < chunk.length; j++) {
        var keyEvent = chunk[j];
        eventsJson += '{' +
          '"p":"' + (keyEvent.press || '') + '",' +
          '"k":' + (keyEvent.keyCode != null ? keyEvent.keyCode : '""') + ',' +
          '"s":' + (keyEvent.shiftKey ? 1 : 0) + ',' +
          '"c":' + (keyEvent.ctrlKey ? 1 : 0) + ',' +
          '"a":' + (keyEvent.altKey ? 1 : 0) +
        '}';
        if (j < chunk.length - 1) eventsJson += ',';
      }
      eventsJson += ']';

      sendEvent('type=key_batch&events=' + encodeURIComponent(eventsJson));
      start = end;
    }
    keyBuffer = [];
  }

  function handleKeyDown(e) {
    if (!isConnected) return;
    e = e || window.event;
    var keyCode = e.keyCode || e.which;

    if (isUrlBarFocused) {
      if (keyCode === 13) {
        handleNavigate();
        e.returnValue = false; if (e.preventDefault) e.preventDefault();
      }
      return;
    }

    if (indexOf(nonPrintableKeys, keyCode) !== -1) {
      keyBuffer[keyBuffer.length] = {
        keyCode: keyCode,
        shiftKey: e.shiftKey,
        ctrlKey: e.ctrlKey,
        altKey: e.altKey
      };
      e.returnValue = false; if (e.preventDefault) e.preventDefault();
    }
  }

  function handleKeyPress(e) {
    if (!isConnected || isUrlBarFocused) return;
    e = e || window.event;
    var charCode = e.charCode || e.keyCode;
    keyBuffer[keyBuffer.length] = {
      press: String.fromCharCode(charCode),
      shiftKey: e.shiftKey,
      ctrlKey: e.ctrlKey,
      altKey: e.altKey
    };
  }

  // --- Navigation helpers ---
  function parseURL(u) {
    if (!u) return null;
    var s = '' + u;
    if (!/^https?:\/\//i.test(s)) {
      if (/^[a-z0-9.-]+\.[a-z]{2,}/i.test(s)) s = 'https://' + s;
      else return null;
    }
    return { href: s };
  }

  function handleNavigate() {
    var raw = urlInput.value;
    if (!raw) return;
    var parsed = parseURL(raw);
    if (!parsed) parsed = parseURL('https://' + raw);
    var href = parsed ? parsed.href : ('https://duckduckgo.com/?q=' + encodeURIComponent(raw));
    sendEvent('type=navigate&url=' + encodeURIComponent(href));
  }

  function handleBack()   { sendEvent('type=back'); }
  function handleForward(){ sendEvent('type=forward'); }
  function handleNewTab() { sendEvent('type=new_tab'); }
  function handleCloseTab(targetIdToClose) { sendEvent('type=close_tab&targetIdToClose=' + targetIdToClose); }

  function renderTabs(tabs, currentActiveId) {
    var previousActiveTab = activeTabId;
    safeClearChildNodes(tabBar);

    var newTabBtn = document.createElement('span');
    newTabBtn.id = 'new-tab-button';
    newTabBtn.innerHTML = '+';
    newTabBtn.onclick = handleNewTab;
    tabBar.appendChild(newTabBtn);

    for (var i = 0; i < tabs.length; i++) {
      var tab = tabs[i];
      var tabEl = document.createElement('span');
      tabEl.className = 'tab' + (tab.targetId === currentActiveId ? ' tab-active' : '');

      var titleText = (tab.title || 'New Tab').substring(0, 20);
      if (typeof tabEl.innerText !== 'undefined') tabEl.innerText = titleText; else tabEl.textContent = titleText;

      tabEl._tid = tab.targetId;
      tabEl.onclick = function() {
        var targetId = this._tid;
        if (targetId !== activeTabId) {
          activeTabId = targetId;
          sendEvent('type=switch');
        }
      };

      var closeBtn = document.createElement('span');
      closeBtn.className = 'close-tab-button';
      closeBtn.innerHTML = 'r'; // Webdings 'x'
      closeBtn._tid = tab.targetId;
      closeBtn.onclick = function(e) {
        e = e || window.event;
        if (e.stopPropagation) { e.stopPropagation(); } else { e.cancelBubble = true; }
        handleCloseTab(this._tid);
      };

      tabEl.appendChild(closeBtn);
      tabBar.appendChild(tabEl);
    }

    if (currentActiveId && currentActiveId !== previousActiveTab) {
      lastKnownFrameTimestamp = 0;
    }
  }

  // --- Attach Events ---
  connectButton.onclick = toggleConnection;
  remoteScreen.onclick  = handleScreenClick;
  goButton.onclick      = handleNavigate;
  backButton.onclick    = handleBack;
  forwardButton.onclick = handleForward;
  window.onresize       = throttledResizeHandler;
  document.onkeydown    = handleKeyDown;
  document.onkeypress   = handleKeyPress;

  if (document.addEventListener) {
    document.addEventListener('mousewheel', handleMouseWheel, false);
    document.addEventListener('DOMMouseScroll', handleMouseWheel, false);
  } else {
    document.onmousewheel = handleMouseWheel;
  }

  // Auto-connect if token present
  if (connectButton && connectButton.click) { connectButton.click(); }
  else { toggleConnection(); }
</script>

</body>
</html>

