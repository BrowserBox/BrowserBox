<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>BrowserBox - Legacy Client</title>
<!-- Ensures correct character rendering and tells IE to use its most standards-compliant mode available -->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=5">

<style type="text/css">
  /* Use system colors for a native look and feel */
  body {
    font-family: "MS Sans Serif", "Tahoma", "Verdana", sans-serif;
    font-size: 12px;
    margin: 0;
    padding: 0;
    background-color: ButtonFace; /* System color for dialog backgrounds */
    color: ButtonText;
    overflow: hidden; /* Prevent scrollbars on the main window */
  }

  /* Main layout table */
  #main-layout {
    width: 100%;
    height: 100%;
    border-spacing: 0;
  }

  /* --- Tab Bar --- */
  #tab-bar {
    background-color: ButtonFace;
    padding: 3px 2px 0 2px;
    border-bottom: 2px solid ThreeDShadow;
    white-space: nowrap;
    overflow: hidden;
  }
  .tab {
    display: inline-block; /* Allows for padding and borders */
    padding: 4px 8px;
    border: 1px solid ButtonFace;
    border-bottom: none;
    margin-right: 2px;
    cursor: pointer;
    background-color: ThreeDLightShadow;
    position: relative;
    top: 1px;
  }
  .tab-active {
    background-color: ButtonFace;
    border: 1px solid ThreeDShadow;
    border-bottom: 1px solid ButtonFace;
    font-weight: bold;
  }

  /* --- Omni Box (Address Bar) --- */
  #omni-box {
    background-color: ButtonFace;
    padding: 5px;
    border-bottom: 2px outset ThreeDFace;
  }
  .omni-button {
    font-size: 12px;
    width: 60px;
    margin-right: 5px;
  }
  #url-input {
    font-size: 12px;
    width: 60%; /* Make it responsive to window size */
  }

  /* --- Content Pane --- */
  #content-pane {
    background-color: #000000; /* Black background for the image area */
    text-align: center;
    vertical-align: top;
    padding: 0;
    border-top: 1px solid ThreeDLightShadow;
  }
  #remote-screen {
    background-color: #FFFFFF;
    cursor: crosshair;
    /* Dimensions will be set by JavaScript to match remote resolution */
  }

  /* --- Status Bar --- */
  #status-bar {
    padding: 3px;
    border-top: 1px solid ThreeDShadow;
    font-size: 10px;
    color: ThreeDDarkShadow;
  }
</style>
</head>

<body>

<!-- Using a table for layout is the most robust method for legacy browsers -->
<table id="main-layout" cellpadding="0" cellspacing="0">
  <!-- Row 1: Session Token Input -->
  <tr style="height: 30px;">
    <td>
      <div style="padding: 5px;">
        Session Token: <input type="text" id="token-input" size="20">
        <button id="connect-button">Connect</button>
      </div>
    </td>
  </tr>

  <!-- Row 2: Tab Bar -->
  <tr style="height: 25px;">
    <td><div id="tab-bar"></div></td>
  </tr>

  <!-- Row 3: Omni Box -->
  <tr style="height: 35px;">
    <td>
      <div id="omni-box">
        <button id="back-button" class="omni-button" disabled>Back</button>
        <button id="forward-button" class="omni-button" disabled>Forward</button>
        <input type="text" id="url-input" disabled>
        <button id="go-button" class="omni-button" disabled>Go</button>
      </div>
    </td>
  </tr>

  <!-- Row 4: Content Pane (takes up all remaining space) -->
  <tr style="height: 100%;">
    <td id="content-pane">
      <img id="remote-screen" src="placeholder.gif" alt="Remote Browser View" width="1024" height="768">
    </td>
  </tr>

  <!-- Row 5: Status Bar -->
  <tr style="height: 20px;">
    <td><div id="status-bar">Status: Disconnected.</div></td>
  </tr>
</table>


<script type="text/javascript">
  // --- Configuration ---
  var API_BASE_PATH = '/api/vwin';
  if ( location && location.origin ) {
    API_BASE_PATH = location.origin + API_BASE_PATH;
  }
  var FRAME_REFRESH_RATE_MS = 1000;
  var TAB_REFRESH_RATE_MS = 3000;
  var RESIZE_THROTTLE_MS = 250;

  // --- State Variables ---
  var sessionToken = null;
  var activeTabId = null;
  var isPolling = false;
  var framePollingInterval = null;
  var tabPollingInterval = null;
  var tabFrameCache = {}; // For fast tab switching
  var resizeTimeout = null;

  // --- Element References ---
  var contentPane = document.getElementById('content-pane');
  var connectButton = document.getElementById('connect-button');
  var tokenInput = document.getElementById('token-input');
  var tabBar = document.getElementById('tab-bar');
  var backButton = document.getElementById('back-button');
  var forwardButton = document.getElementById('forward-button');
  var urlInput = document.getElementById('url-input');
  var goButton = document.getElementById('go-button');
  var remoteScreen = document.getElementById('remote-screen');
  var statusBar = document.getElementById('status-bar');

  // --- Core Functions ---

  function createXmlHttpRequestObject() {
    var xhr;
    try {
      xhr = new XMLHttpRequest();
    } catch (e) {
      try {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      } catch (e) {
        alert("Your browser does not support AJAX, which is required for this application.");
        return null;
      }
    }
    return xhr;
  }
  
  function parseJSON(jsonString) {
    try {
      return eval('(' + jsonString + ')');
    } catch (e) {
      updateStatus("Error: Could not parse server response.");
      return null;
    }
  }

  function toggleConnection() {
    if (isPolling) {
      // --- Disconnect ---
      clearInterval(framePollingInterval);
      clearInterval(tabPollingInterval);
      isPolling = false;
      sessionToken = null;
      activeTabId = null;
      tabFrameCache = {};
      
      connectButton.innerHTML = 'Connect';
      updateStatus('Disconnected.');
      setControlsEnabled(false);
      tabBar.innerHTML = '';
      urlInput.value = '';

    } else {
      // --- Connect ---
      sessionToken = tokenInput.value;
      if (!sessionToken) {
        alert('Please enter a session token.');
        return;
      }
      
      updateStatus('Connecting...');
      isPolling = true;
      
      // Send initial viewport size
      sendViewportSize();

      // Start polling loops
      updateTabs();
      refreshScreen();
      tabPollingInterval = setInterval(updateTabs, TAB_REFRESH_RATE_MS);
      framePollingInterval = setInterval(refreshScreen, FRAME_REFRESH_RATE_MS);

      connectButton.innerHTML = 'Disconnect';
      setControlsEnabled(true);
    }
  }

  function updateTabs() {
    if (!isPolling) return;
    var xhr = createXmlHttpRequestObject();
    var url = API_BASE_PATH + '/tabs?session_token=' + encodeURIComponent(sessionToken) + '&ran=' + Math.random();
    
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
        var data = parseJSON(xhr.responseText);
        if (data) {
          renderTabs(data.tabs, data.activeTarget);
          activeTabId = data.activeTarget;
          for (var i = 0; i < data.tabs.length; i++) {
            if (data.tabs[i].targetId === activeTabId) {
              urlInput.value = data.tabs[i].url;
              break;
            }
          }
        }
      }
    };
    xhr.send(null);
  }

  function renderTabs(tabs, currentActiveId) {
    tabBar.innerHTML = '';
    for (var i = 0; i < tabs.length; i++) {
      var tab = tabs[i];
      var tabEl = document.createElement('span');
      tabEl.className = 'tab';
      if (tab.targetId === currentActiveId) {
        tabEl.className += ' tab-active';
      }
      if (typeof tabEl.innerText !== 'undefined') {
        tabEl.innerText = tab.title.substring(0, 20) || 'New Tab';
      } else {
        tabEl.textContent = tab.title.substring(0, 20) || 'New Tab';
      }
      
      tabEl.setAttribute('data-targetId', tab.targetId);
      
      tabEl.onclick = function() {
        var targetId = this.getAttribute('data-targetId');
        if (targetId !== activeTabId) {
          // **FAST TAB SWITCH**: Load cached image immediately
          if (tabFrameCache[targetId]) {
            remoteScreen.src = tabFrameCache[targetId];
          }
          sendEvent('type=switch&targetId=' + targetId);
          activeTabId = targetId;
          updateTabs();
          refreshScreen();
        }
      };
      
      tabBar.appendChild(tabEl);
    }
  }

  function refreshScreen() {
    if (!isPolling || !activeTabId) return;
    var imageUrl = API_BASE_PATH + '/frame?session_token=' + encodeURIComponent(sessionToken);
    imageUrl += '&ran=' + Math.random();
    remoteScreen.src = imageUrl;

    // **CACHE FRAME**: Store the new image URL in our cache
    tabFrameCache[activeTabId] = imageUrl;

    updateStatus('Connected. Viewing tab: ' + activeTabId);
  }

  function sendEvent(params) {
    if (!isPolling) return;
    // For resize events, activeTabId might be null, but that's okay.
    var eventUrl = API_BASE_PATH + '/event?session_token=' + encodeURIComponent(sessionToken) 
                 + (activeTabId ? '&targetId=' + encodeURIComponent(activeTabId) : '') 
                 + '&' + params;
    
    var tempImage = new Image();
    tempImage.src = eventUrl;
  }
  
  function setControlsEnabled(isEnabled) {
    backButton.disabled = !isEnabled;
    forwardButton.disabled = !isEnabled;
    urlInput.disabled = !isEnabled;
    goButton.disabled = !isEnabled;
  }

  function updateStatus(text) {
    statusBar.innerHTML = 'Status: ' + text;
  }

  // --- NEW: Viewport Sizing Logic ---
  function sendViewportSize() {
    var width = contentPane.clientWidth;
    var height = contentPane.clientHeight;

    // Set the image tag size to prevent scrollbars
    remoteScreen.width = width;
    remoteScreen.height = height;

    sendEvent('type=resize&width=' + width + '&height=' + height);
    updateStatus('Sent viewport dimensions: ' + width + 'x' + height);
  }

  function throttledResizeHandler() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      if (isPolling) {
        sendViewportSize();
      }
    }, RESIZE_THROTTLE_MS);
  }

  // --- Event Handlers ---
  function handleScreenClick(e) {
    e = e || window.event;
    var x = e.offsetX || (e.pageX - remoteScreen.offsetLeft);
    var y = e.offsetY || (e.pageY - remoteScreen.offsetTop);
    sendEvent('type=mousedown&x=' + x + '&y=' + y);
  }

  function handleNavigate() {
    var url = urlInput.value;
    if (!url) return;
    if (url.indexOf('://') === -1) {
      url = 'http://' + url;
    }
    sendEvent('type=navigate&url=' + encodeURIComponent(url));
  }

  function handleBack() {
    sendEvent('type=back');
  }

  function handleForward() {
    sendEvent('type=forward');
  }

  // --- Attach Events ---
  connectButton.onclick = toggleConnection;
  remoteScreen.onclick = handleScreenClick;
  goButton.onclick = handleNavigate;
  backButton.onclick = handleBack;
  forwardButton.onclick = handleForward;
  window.onresize = throttledResizeHandler; // Attach resize handler

</script>

</body>
</html>
