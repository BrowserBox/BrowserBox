<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>BrowserBox - Legacy Client</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=5">
<style type="text/css">
  html, body { height: 100%; }
  body { font-family: "MS Sans Serif", "Tahoma", "Verdana", sans-serif; font-size: 12px; margin: 0; padding: 0; background-color: ButtonFace; color: ButtonText; overflow: hidden; }
  #main-layout { width: 100%; height: 100%; border-spacing: 0; }
  #tab-bar { background-color: ButtonFace; padding: 3px 2px 0 2px; border-bottom: 2px solid ThreeDShadow; white-space: nowrap; overflow: hidden; }
  .tab { display: inline-block; padding: 4px 8px; border: 1px solid ButtonFace; border-bottom: none; margin-right: 2px; cursor: pointer; background-color: ThreeDLightShadow; position: relative; top: 1px; }
  .tab-active { background-color: ButtonFace; border: 1px solid ThreeDShadow; border-bottom: 1px solid ButtonFace; font-weight: bold; }
  #omni-box { background-color: ButtonFace; padding: 5px; border-bottom: 2px outset ThreeDFace; }
  .omni-button { font-size: 12px; width: 60px; margin-right: 5px; }
  #url-input { font-size: 12px; width: 60%; }
  #content-pane { background-color: #000000; text-align: center; vertical-align: top; padding: 0; border-top: 1px solid ThreeDLightShadow; }
  #remote-screen { background-color: #FFFFFF; cursor: crosshair; }
  #status-bar { padding: 3px; border-top: 1px solid ThreeDShadow; font-size: 10px; color: ThreeDDarkShadow; }
</style>
</head>
<body>

<table id="main-layout" cellpadding="0" cellspacing="0">
  <tr style="height: 30px;"><td><div style="padding: 5px;">Session Token: <input type="text" id="token-input" size="20" value="8723e327ccfe57f8803e0f1dd1d780e6"><button id="connect-button">Connect</button></div></td></tr>
  <tr style="height: 25px;"><td><div id="tab-bar"></div></td></tr>
  <tr style="height: 35px;"><td><div id="omni-box"><button id="back-button" class="omni-button" disabled>Back</button><button id="forward-button" class="omni-button" disabled>Forward</button><input type="text" id="url-input" disabled><button id="go-button" class="omni-button" disabled>Go</button></div></td></tr>
  <tr style="height: 100%;"><td id="content-pane"><img id="remote-screen" src="placeholder.gif" alt="Remote Browser View" width="1024" height="768"></td></tr>
  <tr style="height: 20px;"><td><div id="status-bar">Status: Disconnected.</div></td></tr>
</table>

<script type="text/javascript">
  // --- Configuration ---
  var API_BASE_PATH = '/api/vwin';
  if ( location && location.origin ) {
    API_BASE_PATH = location.origin + API_BASE_PATH;
  }
  var POLLING_INTERVAL_MS = 1000; // How often to check for a new frame when idle
  var TAB_REFRESH_RATE_MS = 3000;
  var RESIZE_THROTTLE_MS = 250;

  // --- State Variables ---
  var sessionToken = null;
  var activeTabId = null;
  var isConnected = false;
  var tabPollingInterval = null;
  var resizeTimeout = null;
  var lastKnownFrameTimestamp = 0; // Tracks the timestamp of the last received frame

  // --- Element References ---
  var contentPane = document.getElementById('content-pane');
  var connectButton = document.getElementById('connect-button');
  var tokenInput = document.getElementById('token-input');
  var tabBar = document.getElementById('tab-bar');
  var backButton = document.getElementById('back-button');
  var forwardButton = document.getElementById('forward-button');
  var urlInput = document.getElementById('url-input');
  var goButton = document.getElementById('go-button');
  var remoteScreen = document.getElementById('remote-screen');
  var statusBar = document.getElementById('status-bar');

  // --- Core Functions ---
  function createXmlHttpRequestObject() {
    var xhr;
    try {
      xhr = new XMLHttpRequest();
    } catch (e) {
      try {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      } catch (e) {
        alert("Your browser does not support AJAX, which is required for this application.");
        return null;
      }
    }
    return xhr;
  }
  
  function parseJSON(jsonString) {
    try {
      return eval('(' + jsonString + ')');
    } catch (e) {
      updateStatus("Error: Could not parse server response.");
      return null;
    }
  }

  function toggleConnection() {
    if (isConnected) {
      // --- Disconnect ---
      isConnected = false;
      clearInterval(tabPollingInterval);
      sessionToken = null;
      activeTabId = null;
      lastKnownFrameTimestamp = 0;
      
      connectButton.innerHTML = 'Connect';
      updateStatus('Disconnected.');
      setControlsEnabled(false);
      tabBar.innerHTML = '';
      urlInput.value = '';
    } else {
      // --- Connect ---
      sessionToken = tokenInput.value;
      if (!sessionToken) {
        alert('Please enter a session token.');
        return;
      }
      
      updateStatus('Connecting...');
      isConnected = true;
      
      sendViewportSize();
      updateTabs(); // Initial tab update
      pollForNextFrame(); // Start the first frame poll

      tabPollingInterval = setInterval(updateTabs, TAB_REFRESH_RATE_MS);
      connectButton.innerHTML = 'Disconnect';
      setControlsEnabled(true);
    }
  }

  // --- NEW POLLING LOGIC ---
  function pollForNextFrame() {
    if (!isConnected || !activeTabId) {
      // If we're disconnected or have no active tab, wait and try again.
      setTimeout(pollForNextFrame, POLLING_INTERVAL_MS);
      return;
    }

    var xhr = createXmlHttpRequestObject();
    var url = API_BASE_PATH + '/frame-status?session_token=' + encodeURIComponent(sessionToken) 
            + '&last_known_ts=' + lastKnownFrameTimestamp + '&ran=' + Math.random();

    xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
        var data = parseJSON(xhr.responseText);
        if (data && data.fresh) {
          // New frame is available! Update the timestamp and set the image src.
          // The 'onload' event of the image will trigger the next poll.
          lastKnownFrameTimestamp = data.timestamp;
          remoteScreen.src = API_BASE_PATH + '/frame?session_token=' + encodeURIComponent(sessionToken) + '&ran=' + Math.random();
        } else {
          // No new frame. Wait for the polling interval and check again.
          setTimeout(pollForNextFrame, POLLING_INTERVAL_MS);
        }
      } else if (xhr.readyState === 4) {
        // An error occurred (e.g., server down). Wait and try again.
        setTimeout(pollForNextFrame, POLLING_INTERVAL_MS * 2);
      }
    };
    xhr.send(null);
  }

  function updateTabs() {
    if (!isConnected) return;
    var xhr = createXmlHttpRequestObject();
    var url = API_BASE_PATH + '/tabs?session_token=' + encodeURIComponent(sessionToken) + '&ran=' + Math.random();
    
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
        var data = parseJSON(xhr.responseText);
        if (data) {
          renderTabs(data.tabs, data.activeTarget);
          activeTabId = data.activeTarget;
          for (var i = 0; i < data.tabs.length; i++) {
            if (data.tabs[i].targetId === activeTabId) {
              urlInput.value = data.tabs[i].url;
              break;
            }
          }
        }
      }
    };
    xhr.send(null);
  }

  function renderTabs(tabs, currentActiveId) {
    var previousActiveTab = activeTabId;
    tabBar.innerHTML = '';
    for (var i = 0; i < tabs.length; i++) {
      var tab = tabs[i];
      var tabEl = document.createElement('span');
      tabEl.className = 'tab';
      if (tab.targetId === currentActiveId) {
        tabEl.className += ' tab-active';
      }
      if (typeof tabEl.innerText !== 'undefined') {
        tabEl.innerText = tab.title.substring(0, 20) || 'New Tab';
      } else {
        tabEl.textContent = tab.title.substring(0, 20) || 'New Tab';
      }
      tabEl.setAttribute('data-targetId', tab.targetId);
      tabEl.onclick = function() {
        var targetId = this.getAttribute('data-targetId');
        if (targetId !== activeTabId) {
          sendEvent('type=switch&targetId=' + targetId);
        }
      };
      tabBar.appendChild(tabEl);
    }
    // If the active tab changed, reset the timestamp to force an immediate frame fetch
    if (currentActiveId && currentActiveId !== previousActiveTab) {
        lastKnownFrameTimestamp = 0;
    }
  }

  function sendEvent(params) {
    if (!isConnected) return;
    var eventUrl = API_BASE_PATH + '/event?session_token=' + encodeURIComponent(sessionToken) 
                 + (activeTabId ? '&targetId=' + encodeURIComponent(activeTabId) : '') 
                 + '&' + params;
    
    var tempImage = new Image();
    tempImage.src = eventUrl;
  }
  
  function setControlsEnabled(isEnabled) {
    backButton.disabled = !isEnabled;
    forwardButton.disabled = !isEnabled;
    urlInput.disabled = !isEnabled;
    goButton.disabled = !isEnabled;
  }

  function updateStatus(text) {
    statusBar.innerHTML = 'Status: ' + text;
  }

  function sendViewportSize() {
    var width = contentPane.clientWidth;
    var height = contentPane.clientHeight;
    remoteScreen.width = width;
    remoteScreen.height = height;
    sendEvent('type=resize&width=' + width + '&height=' + height);
    updateStatus('Sent viewport dimensions: ' + width + 'x' + height);
  }

  function throttledResizeHandler() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      if (isConnected) {
        sendViewportSize();
      }
    }, RESIZE_THROTTLE_MS);
  }

  function handleScreenClick(e) {
    e = e || window.event;
    var x = e.offsetX || (e.pageX - remoteScreen.offsetLeft);
    var y = e.offsetY || (e.pageY - remoteScreen.offsetTop);
    sendEvent('type=mousedown&x=' + x + '&y=' + y);
  }

  function handleNavigate() {
    var url = urlInput.value;
    if (!url) return;
    if (url.indexOf('://') === -1) {
      url = 'http://' + url;
    }
    sendEvent('type=navigate&url=' + encodeURIComponent(url));
  }

  function handleBack() {
    sendEvent('type=back');
  }

  function handleForward() {
    sendEvent('type=forward');
  }

  // --- Attach Events ---
  connectButton.onclick = toggleConnection;
  remoteScreen.onclick = handleScreenClick;
  goButton.onclick = handleNavigate;
  backButton.onclick = handleBack;
  forwardButton.onclick = handleForward;
  window.onresize = throttledResizeHandler;

  // This is the key to the new event-driven loop.
  // When an image successfully loads, we immediately check for the next one.
  remoteScreen.onload = function() {
    updateStatus('Frame ' + lastKnownFrameTimestamp + ' loaded.');
    pollForNextFrame();
  };
  // If an image fails to load, we wait a bit then try again.
  remoteScreen.onerror = function() {
    updateStatus('Error loading frame. Retrying...');
    setTimeout(pollForNextFrame, POLLING_INTERVAL_MS);
  };

</script>

</body>
</html>
